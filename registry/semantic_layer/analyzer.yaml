# registry/semantic_layer/analyzer.yaml
# Define your table-level metadata and columns below.
table: analyzer
owner: BI-team
description: >
  Core metadata for the `analyzer` dataset, ingested from monthly exports.
notes: |
  - This dataset also called analyzer provides a consolidated view of monthly sales performance for the all the brands/products of a given division across all territories.
  - It captures both primary (sales to distributors) and secondary (sales to retailers/customers) sales, along with related targets, claims, and returns. 
  - It is intended for sales performance tracking, territory analysis, and brand performance review for each month and captuting poor business hygiene like large claim and return value.

columns:
  - name: Division_Code
    type: integer
    nullable: true
    business_name: "Division Code"
    business_description: "Unique identifier for the sales division."
    example: 71
  - name: Mth
    type: string
    nullable: false
    business_name: "Month"
    business_description: "Month of the calendar year for which the data is recorded."
    examples:
      - "Jan"
      - "Feb"
      - "Mar"
      - "Apr"
      - "May"
      - "Jun"
    special_considerations: "The 'All' value signifies a consolidated total row and should be excluded from individual month-level analysis."
  - name: Terr_Code
    type: string
    nullable: true
    business_name: "Territory Code"
    aliases:
      - "Territory ID"
    business_description: "Code representing the sales territory code."
    examples: 
      - "IT021291"
      - "PT023292"
  - name: TBM_Name
    type: string
    nullable: true
    business_name: "Territory Business Manager Name"
    aliases:
      - "TBM"
    business_description: "Name of the Territory Business Manager."
    example: "John Doe"
    special_considerations: "This field may contain 'NOT ASSIGNED' values if no TBM is assigned."
  - name: Employee_Code
    type: integer
    nullable: true
    business_name: "Employee Code"
    business_description: "Unique code of the Territory Business Manager."
    example: 738218
    special_considerations: "This field may contain 0 if if no TBM is assigned."
  - name: ABM_Name
    type: string
    nullable: true
    business_name: "ABM Name"
    business_description: "Name of the Area Business Manager."
    special_considerations: "This field may contain 'NOT ASSIGNED' values if no ABM is assigned."
  - name: New_ZBM_Name
    type: string
    nullable: true
    business_name: "Zonal Business Manager Name"
    aliases:
      - "ZBM Name"
    business_description: "Name of the Zonal Business Manager."
    special_considerations: "This field may contain 'NOT ASSIGNED' values if no ZBM is assigned."

  - name: Master_Code
    type: integer
    nullable: false
    business_name: "SKU Code"
    aliases:
      - "Material Code"
    business_description: "SKU Code or Material code of the product."
    example: 2040005117
  - name: SKU
    type: string
    nullable: false
    business_name: "SKU Name"
    aliases:
      - "SKU"
    business_description: "Exact name of for the product item or SKU"
    example: "UVOX 50 MG 10S"
  - name: Brand
    type: string
    nullable: false
    business_name: "Brand"
    aliases:
      - "Brand Name"
    business_description: "Brand name of the product."
    example: "Claribid"
  - name: Status
    type: string
    nullable: true
    business_name: "Brand category"
    business_description: "Category of the brand. There are three categories: FOCUS, OTHERS, and New."
    example: "FOCUS"
    special_considerations: "Focus brands means filtering this row for FOCUS category."
  - name: Tgt_Units
    type: float
    nullable: true
    business_name: "Target Units"
    business_description: "Target quantity in units."
    example: 1000
  - name: Sec_Units
    type: float
    nullable: true
    business_name: "Secondary Sales Units"
    business_description: "Actual secondary sales quantity in units"
    example: 950
  - name: LY_Sec_Units
    type: float
    nullable: true
    business_name: "Last Year Secondary Sales Units"
    business_description: "Last year same period Secondary sales quantity in units"
    example: 901.23  
  - name: Prim_Units
    type: float
    nullable: true
    business_name: "Primary Sales Units"
    business_description: "Actual primary sales quantity in units."
    example: 800.12
  - name: LY_Prim_Units
    type: float
    nullable: true
    business_name: "Last Year Primary Sales Units"
    business_description: "Last year same period Primary sales quantity in units"
  - name: CY_Claim_Units
    type: float
    nullable: true
    business_name: "Claim Units"
    aliases:
      - "Non-returnable Units"
      - "Expired Units"
    business_description: "Number of claim units or non-returnable units or expired units."
  - name: LY_Claim_Units
    type: float
    nullable: true
    business_name: "Last year same period Claim Units"
    business_description: "Number of claim units or non-returnable units or expired units in the last year in the same period."
  - name: CY_Return_Units
    type: float
    nullable: true
    business_name: "Return Units"
    business_description: "Number of return units."
  - name: Tgt_Value
    type: float
    nullable: true
    business_name: "Target Value"
    business_description: "Target sales value."
    example: 50000.75
  - name: Sec_Value
    type: float
    nullable: true
    business_name: "Secondary Sales Value"
    business_description: "Actual secondary sales value."
    example: 48000.5
  - name: LY_Sec_Value
    type: float
    nullable: true
    business_name: "Last year Secondary Sales Value"
    business_description: "Actual secondary sales value in the last year in the same period."
  - name: Prim_Value
    type: float
    nullable: true
    business_name: "Primary Sales Value"
    business_description: "Actual primary sales value."
    example: 40000.0
  - name: LY_Prim_Value
    type: float
    nullable: true
    business_name: "Last year Primary Sales Value"
    business_description: "Actual primary sales value in the last year in the same period."
  - name: CY_Claim_Value
    type: float
    nullable: true
    business_name: "Claim Value"
    aliases:
      - "Non-returnable Value"
      - "Expired Value"
    business_description: "Value of claims or non-returnable units or expired units."
  - name: LY_Claim_Value
    type: float
    nullable: true
    business_name: "Last year Claim Value"
    business_description: "Value of claims or non-returnable units or expired units in the last year in the same period."
  - name: CY_Return_Value
    type: float
    nullable: true
    business_name: "Return Value"
    business_description: "Value of returns or returnable units or non-expired units"
  - name: Zone
    type: string
    nullable: true
    business_name: "Sales Zone"
    business_description: "Name of the geographical sales zone."
    example: "North"
  - name: HQ
    type: string
    nullable: true
    business_name: "Headquarter"
    business_description: "Headquarter associated with the record."
    example: "Mumbai"

hierarchies:
  geographic_code:
    name: "Geography"
    levels:
      - name: "Zone"
        columns: ["Zone"]
      - name: "Territory Code"
        columns: ["Terr_Code"]
    relationships:
      - parent: "Zone"  
        child:  "Territory Code"

  product:
    name: "Product"
    levels:
      - name: "Brand"
        columns: ["Brand"]
      - name: "SKU"
        columns: ["SKU"]
    relationships:
      - parent: "Brand"
        child:  "SKU"

  employee:
    name: "Employee"
    levels:
      - name: "Zonal Business Manager"
        columns: ["New_ZBM_Name"]
      - name: "Area Business Manager"
        columns: ["ABM_Name"]
      - name: "Territory Business Manager"
        columns: ["TBM_Name"]
    relationships:
      - parent: "Zonal Business Manager"
        child:  "Area Business Manager"
      - parent: "Area Business Manager"
        child:  "Territory Business Manager"

business_context:
  vocabulary:
    sales_terms:
      "sales": 
        ambiguous: true
        options: ["Prim_Value", "Sec_Value", "Prim_Units", "Sec_Units"]
        clarification_needed: "Primary or Secondary AND Value or Units?"
        default: "Prim_Value"
      "primary sales": "Prim_Value"
      "secondary sales": "Sec_Value" 
      "target": "Tgt_Value"
      "plan": "Tgt_Value"
      "achievement": 
        ambiguous: true
        clarification_needed: "Value Achievement (sales amount) or Unit Achievement (quantity sold)? Achievement to be calculated over Primary or Secondary ?"
        default: "primary_value_achievement_pct"
      "achievement %": "achievement"
      "ach%": "achievement"
    
    time_terms:
      "last year": "LY_prefix"
      "previous year": "LY_prefix" 
      "yoy": "year over year"
      "year over year": "yoy"
      "qoq": "quarter over quarter"
      "quarter over quarter": "qoq"
      
    geographic_terms:
      "region": "Zone"
      "territory": "Terr_Code"
      "zone": "Zone"
      "hq": "HQ"
      "geography": "Zone"
    
  performance_terms:
    "underperforming":          
      aliases: ["underperformance", "non performing", "below target", "non-performance"]         
      filter: 
        metrics: ["primary_value_achievement_pct", "secondary_value_achievement_pct", "primary_unit_achievement_pct", "secondary_unit_achievement_pct"]
        operator: "<"
        value: "1"
        
    "performing":
      aliases: ["achieved", "above target", "overperforming", "exceeding target"]
      filter:
        metrics: ["primary_value_achievement_pct", "secondary_value_achievement_pct", "primary_unit_achievement_pct", "secondary_unit_achievement_pct"] 
        operator: ">="
        value: "1"
        
    "focus brands":
      clarification_needed: "Do you want to analyze only FOCUS category brands?"
      filter:
        column: "Status"
        operator: "="
        value: "'FOCUS'"
        
    # Growth-related terms
    "degrowth":
      aliases: ["de-growth", "negative growth", "decline", "decrease"]
      filter:
        metrics: ["primary_value_yoy_growth_pct", "secondary_value_yoy_growth_pct", "primary_unit_yoy_growth_pct", "secondary_unit_yoy_growth_pct"]
        operator: "<"
        value: "0"
        
    "positive growth":
      aliases: ["growth", "increase", "improvement", "rise"]
      filter:
        metrics: ["primary_value_yoy_growth_pct", "secondary_value_yoy_growth_pct", "primary_unit_yoy_growth_pct", "secondary_unit_yoy_growth_pct"]
        operator: ">"
        value: "0"

  rules:
    data_filters:
      - rule: "exclude_all_month"
        description: "Always exclude Mth = 'All' unless user specifically requests totals"
        default_filter: "Mth != 'All'"
        
      - rule: "focus_brands_clarification"
        description: "When user mentions 'focus brands' or 'brands', clarify if they want FOCUS filter"
        
    calculation_rules:
      - rule: "null_handling"
        description: "Treat NULLs as 0 in calculations"
        
      - rule: "achievement_clarification"
        description: "Achievement requires clarification: Value or Unit AND Primary or Secondary"

      - rule: "growth_clarification"
        description: "Growth requires clarification: Value or Unit  AND Primary or Secondary"


  special_columns:
    Mth:
      type: "temporal"
      special_value: "All"
      exclude_by_default: true
      sequence: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
      
    quarters:
      quarters:
      aggregation_required: true
      definitions:
        Q1: 
          months: ["Jan", "Feb", "Mar"]
          sql_filter: "Mth IN ('Jan', 'Feb', 'Mar')"
        Q2: 
          months: ["Apr", "May", "Jun"]
          sql_filter: "Mth IN ('Apr', 'May', 'Jun')"
        Q3: 
          months: ["Jul", "Aug", "Sep"]
          sql_filter: "Mth IN ('Jul', 'Aug', 'Sep')"
        Q4: 
          months: ["Oct", "Nov", "Dec"]
          sql_filter: "Mth IN ('Oct', 'Nov', 'Dec')"
      aggregation_method: "SUM"
      note: "Quarter metrics require SUM aggregation over constituent months"


metrics:
  # Achievement metrics - 4 variants
  primary_value_achievement_pct:
    name: "Primary Value Achievement"
    formula: "(Prim_Value / Tgt_Value)"
    base_columns: ["Prim_Value", "Tgt_Value"]
    description: "Primary sales value achievement against target"
    
  secondary_value_achievement_pct:
    name: "Secondary Value Achievement"  
    formula: "(Sec_Value / Tgt_Value)"
    base_columns: ["Sec_Value", "Tgt_Value"]
    description: "Secondary sales value achievement against target"
    
  primary_unit_achievement_pct:
    name: "Primary Unit Achievement"
    formula: "(Prim_Units / Tgt_Units)"
    base_columns: ["Prim_Units", "Tgt_Units"]
    description: "Primary sales units achievement against target"
    
  secondary_unit_achievement_pct:
    name: "Secondary Unit Achievement"
    formula: "(Sec_Units / Tgt_Units)" 
    base_columns: ["Sec_Units", "Tgt_Units"]
    description: "Secondary sales units achievement against target"

  # Growth metrics
  primary_value_yoy_growth_pct:
    name: "Primary Value YoY Growth"
    formula: "((Prim_Value - LY_Prim_Value) / LY_Prim_Value)"
    base_columns: ["Prim_Value", "LY_Prim_Value"]
    
  secondary_value_yoy_growth_pct:
    name: "Secondary Value YoY Growth"
    formula: "((Sec_Value - LY_Sec_Value) / LY_Sec_Value)"
    base_columns: ["Sec_Value", "LY_Sec_Value"]
    
  primary_unit_yoy_growth_pct:
    name: "Primary Unit YoY Growth"
    formula: "((Prim_Units - LY_Prim_Units) / LY_Prim_Units)"
    base_columns: ["Prim_Units", "LY_Prim_Units"]
    
  secondary_unit_yoy_growth_pct:
    name: "Secondary Unit YoY Growth"
    formula: "((Sec_Units - LY_Sec_Units) / LY_Sec_Units)"
    base_columns: ["Sec_Units", "LY_Sec_Units"]
    
  qoq_growth_pct:
    name: "Quarter-over-Quarter Growth"
    description: "Growth vs previous quarter (requires quarter aggregation first)"
    calculation_pattern: "((current_quarter_sum - previous_quarter_sum) / previous_quarter_sum)"
    requires_quarter_aggregation: true

  # Gap analysis  
  performance_gap:
    name: "Performance Gap"
    formula: "Tgt_Value - Prim_Value"
    base_columns: ["Tgt_Value", "Prim_Value"]
    description: "Shortfall from target (positive = underachievement)"
    
  # Business hygiene ratios
  claim_ratio:
    name: "Claim Ratio"
    formula: "(CY_Claim_Value / Prim_Value) * 100"
    base_columns: ["CY_Claim_Value", "Prim_Value"]
    description: "Claims as percentage of primary sales"
    
  return_ratio:
    name: "Return Ratio"  
    formula: "(CY_Return_Value / Prim_Value) * 100"
    base_columns: ["CY_Return_Value", "Prim_Value"]
    description: "Returns as percentage of primary sales"
